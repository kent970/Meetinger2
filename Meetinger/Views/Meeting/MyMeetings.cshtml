@using Meetinger.Areas.Identity.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Http
@model IEnumerable<Meeting>
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "MyMeetings";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@foreach (var meeting in Model)
{
    if (meeting.IsCanceled == false)
    {
        <div class="meeting-container">
            <div class="meeting-title">
                @if (meeting.Creator.Email == Context.User.Identity.Name)
                {
                    <span>Creator meeting</span>
                }
                else
                {
                    <span>Participant meeting</span>
                }
            </div>

            <div class="meeting-details">
                <h2>Meeting</h2>
                <h5>@meeting.Name</h5>
                <p>@meeting.Description</p>
                <p>@meeting.MeetingTime</p>
            </div>

            <div class="meeting-participants">
                @if (meeting.Participants != null)
                {
                    <p>
                        @foreach (var mp in meeting.Participants)
                        {
                            if (mp.Participant.Email == Context.User.Identity.Name)
                            {
                                <span>Creator: @meeting.Creator.FirstName</span>
                            }
                            else
                            {
                                <span>@mp.Participant.FirstName</span>
                            }
                        }
                    </p>
                }
            </div>

            <div class="meeting-actions">
                @if (meeting.Creator.Email == Context.User.Identity.Name)
                {
                    <button class="btn btn-outline-primary delete-button" data-meeting-id="@meeting.Id">Cancel meeting</button>
                    @Html.ActionLink("Update meeting", "UpdateMeeting", new { id = meeting.Id }, new { @class = "btn btn-primary" })
                }
                else
                {
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input add-button" name="selectedUser" value="false" data-meeting-id="@meeting.Id">
                        <label class="form-check-label">No</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input add-button" name="selectedUser" value="true" data-meeting-id="@meeting.Id">
                        <label class="form-check-label">Yes</label>
                    </div>
                }
            </div>
        </div>
    }
}

@section Scripts
{
    <script>
        $(".add-button").click(function() {
            var attendanceValue = $(this).val();
            var meetingId = $(this).data("meeting-id");

            $.ajax({
                type: "POST",
                url: "/Meeting/SetAttendance",
                data: {
                    attendance: attendanceValue,
                    meetingId: meetingId
                },
                success: function() {
                    alert("Attendance set successfully");
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log("Ajax request error:");
                    console.log("Status: " + textStatus);
                    console.log("Error: " + errorThrown);
                }
            });
        });
        $(".delete-button").click(function() {
            var meetingId = $(this).data("meeting-id");
            $.ajax({
                type: "POST",
                url: "/Meeting/CancelMeeting",
                data: { meetingId: meetingId },
                success: function() {
                    alert("Meeting canceled");
                },
                error: function() {
                    alert("error!");
                }
            });
        });
    </script>
}